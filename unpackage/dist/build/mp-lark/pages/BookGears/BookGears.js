"use strict";var e=require("../../common/vendor.js"),o=require("../../common/apis/ticket.js"),a=require("../../common/apis/borrow.js"),l=require("../../composables/UseToken.js");require("../../common/http/index.js"),Math||(n+u+t)();const n=()=>"../../components/GearInfoView/GearInfoView.js",t=()=>"../../components/DatePickerView/DatePickerView.js",u=()=>"../../components/OrderItem/OrderItem.js",r=e.defineComponent({setup(n){const{isAdmin:t,openId:u}=l.UseToken(),r=e.ref(),i=e.ref(null),v=e.ref(""),s=e.ref(""),c=e.ref([]),d=e.ref([]),f=e.ref(),m=e.ref(!1),g=e.computed$1((()=>h(v.value,s.value)));let p=0;const h=(e,o)=>{let a="number"==typeof e?e:new Date(e).getTime(),l=("number"==typeof o?o:new Date(o).getTime())-a,n=l%864e5,t=n%36e5;return`${Math.floor(l/864e5)}天${Math.floor(n/36e5)}小时${Math.floor(t/6e4)}分`},b=e.lodash.exports.debounce((()=>{tt.chooseContact({multi:!1,ignore:!1,maxNum:1,limitTips:"选择人数达到上限了",enableChooseDepartment:!0,success(e){console.log(JSON.stringify(e)),r.value=e.data[0]},fail(e){console.log(`chooseContact fail: ${JSON.stringify(e)}`)}})}),100),k=()=>{console.log("click show picker"),p=0,i.value&&i.value.openPicker(v.value)},w=()=>{p=1,i.value&&i.value.openPicker(s.value)},T=o=>{if(console.log("date",o),0===p?v.value=o:s.value=o,v.value&&s.value){const o=e.dayjs(v.value),a=e.dayjs(s.value);if(console.log("sdfds",o.diff(a,"millisecond")),o.diff(a,"millisecond")>0)return e.uni.showModal({title:"错误",content:"开始时间不能大于结束时间",showCancel:!1}),void(m.value=!0);if(a.diff(o,"millisecond")<0)return e.uni.showModal({title:"错误",content:"结束时间不能小于结束时间",showCancel:!1}),void(m.value=!0)}m.value=!1,v.value&&s.value&&I()},I=()=>{const e=c.value.map((e=>(e.booked=!1,e.barcode)));f.value&&f.value._id?o.previewTicket(e,v.value,s.value,f.value._id).then((e=>{const o=e.map((e=>(c.value.map((o=>{o.barcode==e.barcode&&(e.gear=o,o.booked=!0)})),e)));return d.value=o,d})):o.previewTicket(e,v.value,s.value,"").then((e=>{const o=e.map((e=>(c.value.map((o=>{o.barcode==e.barcode&&(e.gear=o,o.booked=!0)})),e)));return d.value=o,d}))},y=e.lodash.exports.debounce((()=>{if(!v.value||!s.value)return void e.uni.showToast({title:"未选择时间"});if(!r.value)return void e.uni.showToast({title:"未选择领用人"});const o=c.value.filter((e=>!e.booked)).map((e=>e.barcode));console.log("barcodes",o),console.log("startDate",v.value),console.log("endDate",s.value),a.adminBorrow({barcodes:o,openId:r.value.openId,pendingLentAt:v.value,pendingReturnAt:s.value}).then((o=>{e.uni.showToast({title:"预定成功"}),e.uni.navigateBack({})}))}),100),M=e.lodash.exports.debounce((()=>{const a=c.value.filter((e=>!e.booked)).map((e=>e.barcode));a.length?f.value&&f.value._id?o.updateTickeDate(f.value._id,v.value,s.value).then((o=>{e.uni.showToast({title:"预定成功"}),e.uni.navigateBack({})})):o.createTicket(a,v.value,s.value).then((o=>{console.log("createTicket",o),e.uni.showToast({title:"预定成功"}),e.uni.navigateBack({})})):e.uni.showToast({title:"时段有冲突",icon:"error"})}),100),j=e.lodash.exports.debounce((()=>{o.cancelTicket(f.value._id).then((o=>{e.uni.navigateBack({})}))}),100);return e.onMounted((()=>{const o=e.uni.getStorageSync("orderInfo"),a=e.uni.getStorageSync("orderInfoMore");console.log("orderInfo",o),console.log("orderInfoMore",a),o?(c.value=o.borrows.map((e=>(e.asset.borrowId=e._id,e.asset))),v.value=o.pendingLentAt,s.value=o.pendingReturnAt,f.value=o,e.uni.removeStorageSync("orderInfo")):a?(c.value=a.borrows.map((e=>e.asset)),v.value=a.pendingLentAt,s.value=a.pendingReturnAt,f.value=a,f.value._id="",e.uni.removeStorageSync("orderInfoMore")):e.uni.getStorage({key:"selectedGears",success:o=>{c.value=o.data,console.log("selectedGears",c.value),e.uni.removeStorageSync("selectedGears")}})})),(a,l)=>e.e({a:e.f(c.value,((a,l,n)=>e.e({a:"10c04a64-0-"+n,b:e.p({gear:a})},1!==c.value.length?{c:e.o((e=>((e,a)=>{console.log("gear",e),f.value?o.removeGear(f.value._id,e.borrowId).then((e=>{c.value.splice(a,1)})):c.value.splice(a,1)})(a,l)))}:{},{d:a._id}))),b:1!==c.value.length,c:e.unref(t)},e.unref(t)?e.e({d:r.value},r.value?{e:e.t(r.value.openId)}:{},{f:e.o(((...o)=>e.unref(b)&&e.unref(b)(...o)))}):{},{g:v.value},v.value?{h:e.t(v.value&&e.unref(e.dayjs)(v.value).format("MM月DD日 HH:mm"))}:{},{i:e.o(k),j:s.value},s.value?{k:e.t(s.value&&e.unref(e.dayjs)(s.value).format("MM月DD日 HH:mm"))}:{},{l:e.o(w),m:v.value&&s.value&&!m.value},v.value&&s.value&&!m.value?{n:e.t(e.unref(g))}:{},{o:d.value.length},d.value.length?{p:e.f(d.value,((o,a,l)=>({a:e.t(o.gear.name),b:"10c04a64-1-"+l,c:e.p({info:o,bgColor:"#FFFFFF"}),d:o._id})))}:{},{q:f.value&&f.value._id},f.value&&f.value._id?{r:e.o(((...o)=>e.unref(j)&&e.unref(j)(...o)))}:{},{s:!e.unref(t)},e.unref(t)?{}:{t:e.t(f.value?"修改":"立即"),v:m.value,w:e.o(((...o)=>e.unref(M)&&e.unref(M)(...o)))},{x:e.unref(t)},e.unref(t)?{y:m.value,z:e.o(((...o)=>e.unref(y)&&e.unref(y)(...o)))}:{},{A:e.sr(i,"10c04a64-2",{k:"datePickerRef"}),B:e.o(T)})}});tt.createPage(r);
